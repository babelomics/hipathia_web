<link rel="import" href="../bower_components/polymer/polymer.html">
<script>
    HipathiaFormBehavior = {
        properties: {
            userData: {
                type: Object
            },
            toolId: {
                type: String,
                value: 'hipathia'
            },
            execution: {
                type: String
            },
            errorMessage: {
                type: String,
            },
            designConditions: {
                type: Array
            },
            pathwaysList: {
                type: Array
            },
            variantBioformat: {
                type: Array,
                value: [BIOFORMATS["VARIANT"]]
            },
            matrixBioformat: {
                type: Array,
                value: [BIOFORMATS["DATAMATRIX_EXPRESSION"]]
            },
            designBioformat: {
                type: Array,
                value: [BIOFORMATS["EXPERIMENTAL_DESIGN"]]
            },
            expressionMode: {
                type: String,
                value: 'matrix'
            },
            design_type: {
                type: String,
                value: 'categorical'
            },
            
            runTest: {
                type: Boolean,
                value: false
            }
        },
        handlePathSource: function(e) {
            this._loadPathwaysList(e.currentTarget.value);
        },
        _loadPathwaysList: function(sp) {
            var me = this;
            var request = new XMLHttpRequest();
            request.onload = function() {
                var pathwaysList = [];
                var pwMap = JSON.parse(this.responseText);
                for (key in pwMap) {
                    pathwaysList.push({
                        name: pwMap[key],
                        value: key,
                        selected: true
                    });
                }
                me.set('pathwaysList', pathwaysList);
            };
            request.onerror = function() {
                console.log('Error loading pathway_list.json');
            };
            request.open("GET", './'+sp+'_pathway_list.json');
            request.send();
        },
        checkNullFile: function(file) {
            return file == null;
        },
        _checkValue: function(val, currentVal) {
            return val !== currentVal;
        },
        handleDesignType: function(e) {
            this.set('design_type', e.currentTarget.value);
        },

        checkExpFile: function(e) {
            var file = e.currentTarget.selectedFile;
            var bool = (file != null && file.bioformat == "DATAMATRIX_EXPRESSION");
            if (bool) {
                this.$.exp_fileError.innerHTML = '';
            } else {
                this.$.exp_fileError.innerHTML = 'This file is not a matrix expression file';
            }
            return bool;
        },

        checkDesignFile: function(e) {
            var file = e.currentTarget.selectedFile;
            this._getConditionsFromDesignFile(file._id);

            var bool = (file != null && file.bioformat == "EXPERIMENTAL_DESIGN");
            if (bool) {
                this.$.design_fileError.innerHTML = '';
            } else {
                this.$.design_fileError.innerHTML = 'This file is not a experimental design file';
            }
            return bool;
        },

        _getConditionsFromDesignFile: function(fileId) {
            var me = this;
            CbaManager.getFileContent(fileId, function(content) {
                var conditionMap = {};
                var conditionArray = [];
                var line, fields, field;
                var lines = content.split('\n');
                var isNumber;
                if (lines.length > 0) {
                    for (var i = 0; i < lines.length; i++) {
                        line = lines[i];
                        if (line != '') {
                            fields = line.split('\t');
                            if (conditionMap[fields[1]] !== true) {
                                conditionMap[fields[1]] = true;
                                conditionArray.push({
                                    name: fields[1]
                                });
                            }
                        }
                    }
                }
                me.$.condition1Select.set('selected', null);
                me.$.condition2Select.set('selected', null);
                me.set('designConditions', conditionArray);
                me.$.condition1Select.set('selected', conditionArray[0]);
                me.$.condition2Select.set('selected', conditionArray[1]);
            });
        },

        _setError: function(id, msg) {
            this.$[id + 'Error'].innerHTML = msg;
            this.errorMessage = "There are errors in the form. Correct them before launching the job.";
        },
        _clearError: function(id) {
            this.$[id + 'Error'].innerHTML = '';
        },

        handleSelectPW: function(e) {
            if (e.currentTarget.checked === true) {
                this.selectAllPw();
            } else {
                this.deselectAllPw();
            }
        },
        selectAllPw: function(e) {
            var els = this.$.pathwaysContent.querySelectorAll('input[type=checkbox]');
            for (var i = 0; i < els.length; i++) {
                els[i].checked = true;
            }
        },

        deselectAllPw: function(e) {
            var els = this.$.pathwaysContent.querySelectorAll('input[type=checkbox]');
            for (var i = 0; i < els.length; i++) {
                els[i].checked = false;
            }
        }
    };
</script>
