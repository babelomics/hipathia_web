<script src="bower_components-1.x/cba-elements/src/manager/cba-manager.js"></script>

<link rel="import" href="bower_components/polymer/polymer-element.html">
<!--
<script src="bower_components/cookies-js/dist/cookies.min.js"></script>
<script src="bower_components/crypto-js/core.js"></script>
<script src="bower_components/crypto-js/sha1.js"></script>-->

<link rel="import" href="bower_components-1.x/cba-elements/src/elm-header.html">
<link rel="import" href="bower_components-1.x/cba-elements/src/elm-application-behavior.html">
<link rel="import" href="bower_components-1.x/cba-elements/src/elm-footer.html">
<link rel="import" href="bower_components-1.x/cba-elements/src/elm-select.html">
<link rel="import" href="bower_components-1.x/cba-elements/src/elm-select-box.html">
<link rel="import" href="bower_components-1.x/cba-elements/src/elm-panel.html">
<link rel="import" href="bower_components-1.x/cba-elements/src/dropdown/elm-dropdown.html">

<link rel="import" href="bower_components-1.x/cba-elements/src/table/elm-table.html">
<link rel="import" href="bower_components-1.x/cba-elements/src/form/elm-file-origin.html">
<link rel="import" href="bower_components-1.x/cba-elements/src/file/elm-file-browser.html">
<link rel="import" href="bower_components-1.x/cba-elements/src/job/elm-job-browser.html">
<link rel="import" href="bower_components-1.x/cba-elements/src/elm-cluster-status.html">
<link rel="import" href="bower_components-1.x/cba-elements/src/report/elm-report.html">

<link rel="import" href="src/hipathia-home.html">
<link rel="import" href="src/hipathia-signaling-form.html">
<link rel="import" href="src/hipathia-prediction-form.html">

<dom-module id="hipathia-element">
    <template>
        <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning"></style>
        <style>
            .content,elm-footer,elm-header{
                position:absolute
            }
            #description,.userid{
                color:var(--accent-color)
            }
            :host{
                display:block;
                position:relative;
                cursor:default;
                font-size:13px;
                background-color:var(--default-primary-color);
                height:100%;
                width:100%
            }
            elm-header{
                top:0
            }
            elm-footer{
                bottom:0
            }
            .content{
                width:100%;
                top:50px
            }
            #fileBrowserPanel,#jobBrowserPanel{
                position:absolute;
                top:0;
                width:600px;
                height:400px;
                min-width:600px;
                min-height:400px
            }
            #fileBrowserPanel{
                left:0
            }
            #jobBrowserPanel{
                right:0
            }
            @media (max-width:1100px){
                .option-text{
                    display:none
                }
            }
            .userid{
                font-size:16px
            }
            #description{
                font-weight:400
            }
            hipathia-home{
                height:calc(100vh - 100px);
                overflow-y:auto
            }
            elm-report,hipathia-prediction-form,hipathia-signaling-form{
                height:calc(100vh - 50px);
                overflow-y:auto
            }
        </style>

        <div class="content" menu-option="home">
            <hipathia-home id="home" on-start="handleHomeStart" isLogged="{{isLogged}}"></hipathia-home>
        </div>

        <div id="jobContent" class="content" menu-option="job">
            <elm-report id="report" hide-relaunch></elm-report>
        </div>

        <div class="content" menu-option="home,job,signaling,prediction">
            <elm-panel id="jobBrowserPanel" hidden collapsible movable closable on-hidden="handlePanelHidden">
                <div class="header">
                    <i class="fa fa-flask"></i>&nbsp; Browse my jobs
                </div>
                <elm-job-browser id="jobBrowser" class="container flex" on-jobselect="handleJobSelect" allowed-tools="{{allowedTools}}" on-need-refresh="handleUserNeedRefresh" user-data="{{userData}}" disable-relaunch="{{disableRelaunch}}" hide-status-filter="{{hideStatusFilter}}" hide-tool-filter="{{hideToolFilter}}">
                </elm-job-browser>
            </elm-panel>
            <elm-panel id="fileBrowserPanel" hidden collapsible movable closable resizable on-hidden="handlePanelHidden">
                <div class="header">
                    <i class="fa fa-cloud"></i>&nbsp; Browse my data
                </div>
                <elm-file-browser id="fileBrowser" class="container flex" on-fileselect="handleFileSelect" bioformats="{{bioformats}}" on-need-refresh="handleUserNeedRefresh" user-data="{{userData}}">
                </elm-file-browser>
            </elm-panel>
        </div>

        <div class="content" menu-option="signaling">
            <hipathia-signaling-form id="signalingForm" selectedOption="{{selectedOption}}" bioformats="{{bioformats}}" user-data="{{userData}}" on-job-launched="handleJobLaunched"></hipathia-signaling-form>
        </div>

        <div class="content" menu-option="prediction">
            <hipathia-prediction-form id="predictionForm" selectedOption="{{selectedOption}}" bioformats="{{bioformats}}" user-data="{{userData}}" on-job-launched="handleJobLaunched"></hipathia-prediction-form>
        </div>

        <elm-header id="elmHeader" hide-jobs hide-browse selected-option="{{selectedOption}}" user-data="{{userData}}" on-login="handleLogin" on-logout="handleLogout">
            <div class="icon">
                <img src="images/icon.svg" style="height: 44px;margin: 5px 3px 0 0;">
            </div>
            <div class="title" style="margin-left:15px;">
                <span>hi</span><span style="font-weight:normal">P</span><span>athia 2</span>
            </div>
            <span id="description" class="description">
                Pathways analysis suite
            </span>

            <div id="menu" class="menu horizontal layout center flex">
                <!-- <div class="flex"></div> -->
                <div style="margin-left:4vw;"></div>
                <div title="" class="option" on-click="handleMenuOption" data-option="home">
                    <i class="fa fa-home"></i>
                    <span class="option-text">Home</span>
                </div>
                <div style="margin-left:2vw;"></div>
                <div title="Open differential signaling form" class="option" on-click="handleMenuOption" login-required data-option="signaling">
                    <i class="fa fa fa-usb fa-flip-vertical"></i>
                    <span class="option-text">Differential signaling</span>
                </div>
                <div title="Open prediction form" class="option" on-click="handleMenuOption" login-required data-option="prediction">
                    <i class="fa fa-magic"></i>
                    <span class="option-text">Prediction</span>
                </div>

                <div class="flex" style="margin-left:2vw;"></div>
                <div title="Browse my data" class="option" on-click="handleMenuPanel" login-required login-visible data-panel="fileBrowserPanel">
                    <i class="fa fa-cloud"></i>
                    <span class="option-text">My data</span>
                </div>
                <div title="Browse my jobs" class="option" on-click="handleMenuPanel" login-required login-visible data-panel="jobBrowserPanel">
                    <i class="fa fa-flask"></i>
                    <span class="option-text">My jobs</span>
                </div>
                <!-- <div style="margin-left:2vw;"></div> -->
            </div>

            <elm-dropdown dark class="helpmenu">
                <div data-button><i class="fa fa-question-circle"></i></div>
                <ul data-menu>
                    <a href="http://hipathia.babelomics.org/doc" target="_blank">
                        <li>
                            <i class="fa fa-book"></i> &nbsp; Documentation
                        </li>
                    </a>
                    <a href="http://hipathia.babelomics.org/doc/doku.php?id=how_to_cite_hipathia" target="_blank">
                        <li>
                            <i class="fa fa-pencil-square-o"></i> &nbsp; How to cite HiPathia
                        </li>
                    </a>
                    <li data-divider></li>
                    <li>
                        <div on-mousedown="handleExample" data-example-name="differential-signaling">
                            <i class="fa fa-lightbulb-o"></i> &nbsp; Differential signaling example
                        </div>
                    </li>
                    <li>
                        <div on-mousedown="handleExample" data-example-name="prediction-train">
                            <i class="fa fa-lightbulb-o"></i> &nbsp; Prediction train example
                        </div>
                    </li>
                    <li>
                        <div on-mousedown="handleExample" data-example-name="prediction-test">
                            <i class="fa fa-lightbulb-o"></i> &nbsp; Prediction test example
                        </div>
                    </li>
                </ul>
            </elm-dropdown>
            <elm-cluster-status id="clusterStatus" type="dark" class="cluster-status"></elm-cluster-status>
        </elm-header>

        <elm-footer menu-option="home,login,signup,profile,remember" class="horizontal layout center center-justified" style="padding:0 20px;">
            <div style="text-align:center;">
            hi<b>P</b>athia v<span>{{version}}</span>
            <br> Created by
            <span style="font-weight:bold;">Clinical Bioinformatics Area</span>
            <br> Fundación Progreso y Salud (FPS), Sevilla, Spain
            <br> 2018
            </div>
        </elm-footer>
    </template>

    <script>

    class hipathiaElement extends Polymer.mixinBehaviors([elmApplicationBehavior], Polymer.Element) {

        static get is() {
            return 'hipathia-element'
        }

        constructor() {
            super();
        }

        static get properties() {
            return {
                bioformats: {
                    type: Array,
                    notify: true,
                    value: [BIOFORMATS["DATAMATRIX_EXPRESSION"], BIOFORMATS["VARIANT"], BIOFORMATS["EXPERIMENTAL_DESIGN"]]
                },
                allowedTools: {
                    type: Array,
                    value: function () {
                        return ['hipathia.differential-signaling', 'hipathia.prediction-train', 'hipathia.prediction-test', 'utils.report'];
                    }
                }
            }

        }

        // TODO listeners: polymer 2.x

        // listeners: {
        //     'open-job-folder': 'handleOpenJobFolder'
        // }


        created() {
        }

        selectedOptionChanged(neo, old) {
            if (this.selectedOption == 'signaling' || this.selectedOption == 'prediction') {
                this.$.fileBrowserPanel.hide();
                this.$.jobBrowserPanel.hide();
            }
        }

        ready() {
            super.ready();
            var me = this;
            this.selectedOption = "home";
            this.checkShowMenuOnLogin();
        }

        handleOpenJobFolder(e) {
            var job = e.detail;
            this.$.fileBrowser.set('folder', job.folder);
            this.$.fileBrowserPanel.show();
        }
        handleFileSelect(e) { }

        handleJobSelect(e) {
            var me = this;
            var job = e.detail;
            if (job && job.status === 'DONE') {
                this.set('selectedOption', 'job');
                this.$.report.hideJobInformation = true;
                this.$.report.set('job', job);
                //
                // while (this.$.jobContent.firstChild) {
                //     this.$.jobContent.removeChild(this.$.jobContent.firstChild);
                // }
                // var report = document.createElement('elm-report');
                // Polymer.dom(me.$.jobContent).appendChild(report);
            }
        }

        handleJobLaunched() {
            this.setMenu('home');
            this.$.jobBrowserPanel.show();
            this.$.elmHeader.getUserInfo(true);
        }

        handleLogin() {
            if (Cookies('bioinfo_user').indexOf("anonymous___") != -1) {
                this.setMenu('signaling');
            } else {
                this.selectedOption = "home";
            }
            if (this._lastLogedRequest) {
                this._lastLogedRequest = null;
            }
            if (this._lastExampleRequest) {
                this.runExample(this._lastExampleRequest);
                this._lastExampleRequest = null;
            }
            this.$.home.isLogged = true;
            this.checkShowMenuOnLogin();
        }

        handleLogout() {
            this.$.home.isLogged = false;
            this.setMenu('home');
            this.checkShowMenuOnLogin();
        }
        handleUserNeedRefresh() {
            this.$.elmHeader.getUserInfo(true);
        }
        handleHomeStart() {
            if (this.$.elmHeader.isLogged != true) {
                this.$.elmHeader.anonymousSign();
            }
        }
        handleExample(e) {
            if (this.$.elmHeader.isLogged != true) {
                this._lastExampleRequest = e.currentTarget.dataset['exampleName'];
                this.$.elmHeader.anonymousSign();
            } else {
                this.runExample(e.currentTarget.dataset['exampleName']);
                this.$.jobBrowserPanel.show();
            }
        }
        runExample(exname) {
            if (exname === 'differential-signaling') {
                this.$.signalingForm.runExample();
            }
            if (exname === 'prediction-train') {
                this.$.predictionForm.runTrainExample();
            }
            if (exname === 'prediction-test') {
                this.$.predictionForm.runTestExample();
            }
        }
    }
    customElements.define(hipathiaElement.is, hipathiaElement);
    </script>
</dom-module>
